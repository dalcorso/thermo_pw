%!
%! Copyright (C) 2014-2024 Andrea Dal Corso 
%! This file is distributed under the terms of the
%! GNU General Public License. See the file `License'
%! in the root directory of the present distribution,
%! or http://www.gnu.org/copyleft/gpl.txt .
%!
\documentclass[12pt,a4paper,twoside]{report}
\def\version{2.0.1}

\usepackage[T1]{fontenc}
\usepackage{tcolorbox}
\usepackage{bookman}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage[Lenny]{fncychap}
\usepackage{color}
\usepackage{geometry}
\usepackage{amsmath}
\usepackage{amsbsy}
\usepackage{amssymb}
\usepackage{mathtools}

\tcbuselibrary{breakable}
\pagestyle{fancy}
\lhead{Symmetry guide}
\rhead{}
\cfoot{\thepage}

\newgeometry{
      top=3cm,
      bottom=3cm,
      outer=2.25cm,
      inner=2.75cm,
}

\definecolor{web-blue}{rgb}{0,0.5,1.0}
\definecolor{steelblue}{rgb}{0.27,0.5,0.7}
\definecolor{coral}{rgb}{1.0,0.5,0.3}
\definecolor{red}{rgb}{1.0,0,0.0}
\definecolor{green}{rgb}{0.,0.5,0.0}
\definecolor{dark-blue}{rgb}{0.,0.0,0.6}
\definecolor{limegreen}{rgb}{0.19,0.8,0.19}
\definecolor{orange}{rgb}{1.0,0.44,0.0}
\definecolor{violet}{rgb}{0.50,0.33,0.9}
\definecolor{light-yellow}{rgb}{0.94,0.85,0.62}

\tcbset{colback=light-yellow,colframe=dark-blue,breakable}

\def\qe{{\sc Quantum ESPRESSO}}
\def\pwx{\texttt{pw.x}}
\def\phx{\texttt{ph.x}}
\def\configure{\texttt{configure}}
\def\PWscf{\texttt{PWscf}}
\def\PHonon{\texttt{PHonon}}
\def\tpw{\texttt{thermo\_pw}}
\def\make{\texttt{make}}


\begin{document}
\author{Andrea Dal Corso \\ (SISSA - Trieste)}
\date{}

\title{
%  \includegraphics[width=8cm]{thermo_pw.jpg} \\
  \vspace{3truecm}
  % title
  \Huge \color{dark-blue} Symmetries in Quantum ESPRESSO \ \\
   (v.\version)
}

\maketitle

\newpage

\tableofcontents

\newpage
\newpage
{\color{dark-blue}\chapter{Introduction}}
These notes describe how to exploit symmetry in the calculation of
quantities that appear in electronic structure codes. The exposition
is divided in two parts.
In the first part we will use only the space group operation of a
solid, in the second part we will consider also the magnetic symmetries
and assume that each symmetry of the space group might need a time reversal operation.

\section{Preliminary definitions}
The equilibrium positions of the atoms in a solid are determined by
a Bravais lattice and by the position of the atoms inside a unit cell.

The Bravais lattice is determined by three primitive vectors that
we indicate with
\begin{equation}
{\bf a}_1, {\bf a_2}, {\bf a}_3.
\end{equation}
Each point of the lattice is determined by three integer values
$n_1, n_2, n_3$ that can be positive, negative, or null.
We indicate with ${\bf R}_\mu$ the coordinates of the Bravais lattice
points:
\begin{equation}
{\bf R}_\mu = n_1 {\bf a}_1 + n_2 {\bf a}_2 + n_3 {\bf a}_3,
\end{equation}
We indicate with $\boldsymbol{\tau}_s$ the positions of the atoms
inside the unit cell ($s=1,\cdots, N_{at}$).
Each atom $s$ within the
unit cell has a type that we call $\gamma(s)$.
The equilibrium positions of the atoms in the solid are therefore:
\begin{equation}
{\bf R}_I = {\bf R}_\mu + \boldsymbol{\tau}_s,
\end{equation}
and the index $I=\{\mu,s\}$ is a composite index that indicates both the
Bravais lattice and the atom inside the unit cell.

We say that a rototranslation that we indicate with $\{S,{\bf a}\}$, where
$S$ is a proper
(or improper) rotation and ${\bf a}$ is a translation, belongs to the solid
space group if for any $I=\{\mu,s\}$ there is an
$\bar I=\{\bar \mu,\bar s\}$ such that:
\begin{equation}
\{S,{\bf a}\} {\bf R}_I = S {\bf R}_\mu + S \boldsymbol{\tau}_s + {\bf a} =
{\bf R}_{\bar \mu} + \boldsymbol{\tau}_{\bar s}
\label{sg}
\end{equation}
and $\gamma(s)=\gamma(\bar s)$.

The operations $\{S_i,{\bf a}_i\}$ for which Eq.~\ref{sg} holds
form a group known as the solid space group.
We have
\begin{equation}
\{S_i,{\bf a}_i\} \{S_j,{\bf a}_j\} = \{S_i S_j,S_i {\bf a}_j + {\bf a}_i\}
\end{equation}
The neutral element of the group is $\{\mathbb{I},{\bf 0}\}$ where
$\mathbb{I}$ is the identity matrix and ${\bf 0}$ is the null translation.
The inverse of an element is
\begin{equation}
\{S_i,{\bf a}_i\}^{-1} = \{S_i^{-1}, -S_i^{-1} {\bf a}_i \}.
\end{equation}
It is useful also to introduce the fractional translations ${\bf f}_i$,
by considering the vector ${\bf R}_{\mu_i}$ closer to ${\bf a}_i$ and
writing the operations of the space group as
\begin{equation}
\{S_i,{\bf a}_i\}= \{S_i,{\bf R}_{\mu_i}+{\bf f}_i\}.
\end{equation}
The set of rotations $\{S_i\}$ form a group called the solid point group. In general, the
set $\{S_i,{\bf 0}\}$ is not a subgroup of the space group.

\section{Coordinates}

\subsection{The rotation matrix}

There are two ways to express the rotation matrices $S$ of the space
group. We can consider the three vectors that results from the application
of $S$ to ${\bf a}_1$, ${\bf a}_2$, and ${\bf a}_3$. Since they must
be Bravais lattice vectors they can be expressed as
\begin{equation}
{\bf a}'_l = \sum_{m=1}^3 S_{l,m} {\bf a}_m,
\label{scrys}
\end{equation}
where $S_{l,m}$ is a $3\times3$ integer matrix.
An alternative is to introduce Cartesian coordinates and write the primitive
vectors as ${\bf a}_{\alpha,i}$ where $\alpha$ indicates a Cartesian coordinate.
We can indicate the Cartesian rotation matrix in Cartesian as $S_{\alpha,\beta}$
and we have:
\begin{equation}
{\bf a}'_{\alpha,l} = \sum_{\beta=1}^3 S_{\alpha,\beta} {\bf a}_{\beta,l}.
\label{scart}
\end{equation}

Note that the matrix $S_{\alpha,\beta}$ is an orthogonal ($S_{\beta,\alpha}=S^{-1}_{\alpha,\beta} $) $3\times 3$ matrix, while 
$S_{l,m}$ in general is not orthogonal. We
can write $S_{\alpha,\beta}$ in terms of $S_{l,m}$ or $S_{l,m}$ in terms
of $S_{\alpha,\beta}$ using the following considerations.

Assuming that ${\bf a}_m$ are in units of $a$ (the lattice constants) we
can introduce the primitive reciprocal lattice vector ${\bf b}_1$, ${\bf b}_2$,
and ${\bf b}_3$ (in units of $2\pi \over a$) with the property that
\begin{equation}
{\bf a}_i \cdot {\bf b}_j = \sum_{\alpha=1}^3 {\bf a}_{\alpha,i} {\bf b}_{\alpha, j} =  \delta_{i,j}.
\label{recips}
\end{equation}
From this equation one derives also that:
\begin{equation}
\sum_{j=1}^3 {\bf b}_{\alpha, j} {\bf a}_{\beta, j} =  \delta_{\alpha,\beta}.
\label{complete}
\end{equation}
 
Multiplying Eq.~\ref{scrys} by ${\bf b}_{\alpha, j}$, summing on $\alpha$ and
using Eq.~\ref{recips} we have
\begin{equation}
\sum_{\alpha=1}^3 {\bf a}'_{\alpha,l} {\bf b}_{\alpha, j} = S_{l,j},
\end{equation}
and now using Eq.~\ref{scart} we have
\begin{equation}
S_{l,j} =\sum_{\alpha=1}^3 \sum_{\beta=1}^3 {\bf b}_{\alpha, j} S_{\alpha,\beta} {\bf a}_{\beta,l}.
\label{slj}
\end{equation}

The inverse of this equation can be found multiplying both terms by
${\bf a}_{\gamma,j}$ and ${\bf b}_{\delta,l}$, summing over $j$ and $l$ and
using Eq.~\ref{complete} twice:
\begin{equation}
\sum_{l,j} {\bf b}_{\delta,l} S_{l,j} {\bf a}_{\gamma,j} = S_{\gamma,\delta}.
\end{equation}

\subsection{Rotation of a vector}
When we have the cartesian coordinates of a vector
${\bf v}$, the rotated cartesian coordinates are:
\begin{equation}
{\bf v}'_\alpha = \sum_{\beta=1}^3 S_{\alpha,\beta} {\bf v}_\beta.
\end{equation}

When the vector ${\bf v}$ is expressed in crystal coordinates:
\begin{equation}
{\bf v} = \sum_{l=1}^3 {\bf v}_l {\bf a}_l.
\end{equation}
the rotated vector can be written as
\begin{equation}
{\bf v}' = \sum_{i=1}^3 {\bf v}_l {\bf a}'_l.
\end{equation}
and its coordinates can also be written again in the original basis
${\bf a}_i$ using Eq.~\ref{scrys}:
\begin{equation}
{\bf v}' = \sum_{l=1}^3 \sum_{m=1}^3 {\bf v}_l S_{l,m} {\bf a}_m,
\end{equation}
with
\begin{equation}
{\bf v}'_m = \sum_{l=1}^3 {\bf v}_l S_{l,m}.
\label{rotvcry}
\end{equation}

\subsection{Rotations in reciprocal space}

We can calculate the rotated of the vectors
${\bf b}_1$, ${\bf b}_2$,
and ${\bf b}_3$. They must be reciprocal lattice vectors so they can be written as linear combination
of ${\bf b}_1$, ${\bf b}_2$,
and ${\bf b}_3$:
\begin{equation}
{\bf b'}_j = \sum_{m=1}^3 U_{j,m} {\bf b}_m,
\end{equation}
where the matrix $U_{j,m}$ is an integer matrix.
Since
\begin{equation}
{\bf a}'_i \cdot {\bf b'}_j = \delta_{i,j},
\end{equation}
we must have:
\begin{equation}
\sum_{l=1}^3 \sum_{m=1}^3 S_{i,l} {\bf a}_l \cdot U_{j,m} {\bf b_m} =  \sum_{l=1}^3 S_{i,l} U_{j,l} =
\delta_{i,j}.
\end{equation}
From this equation we find that
\begin{equation}
U_{j,l} = S^{-1}_{l,j},
\end{equation}
where the operator $S^{-1}$ is the inverse of the rotation $S$, belong to the symmetry group, and is an integer matrix.

We can write the rotated of the principal lattice vectors as:
\begin{equation}
{\bf b'}_j = \sum_{m=1}^3 S^{-1}_{m,j} {\bf b}_m.
\end{equation}

With this equation we can now see how to rotate 
a vector ${\bf v}$ written in the basis of
the primitive reciprocal lattice vectors. We have:
\begin{equation}
{\bf v} = \sum_{l=1}^3 {\bf v}_l {\bf b}_l.
\end{equation}
and the rotated vector is
\begin{equation}
{\bf v}' = \sum_{l=1}^3 {\bf v}_l {\bf b}'_l,
\end{equation}
or, in the original reciprocal primitive basis:
\begin{equation}
{\bf v}' = \sum_{l=1}^3 \sum_{m=1}^3 {\bf v}_l S^{-1}_{m,l} {\bf b}_m.
\end{equation}
So the components rotate as:
\begin{equation}
{\bf v}'_m = \sum_{l=1}^3 {\bf v}_l S^{-1}_{m,l}.
\label{rotreccomp}
\end{equation}

\subsection{Change of basis}
When a vector is given in Cartesian coordinates (${\bf v}_{\alpha}$) we can write it in the basis of the primitive Bravais lattice vectors.
We have:
\begin{equation}
{\bf v}= \sum_{l=1}^3 {\bf v}_l {\bf a}_l.
\end{equation}
Multiplying both members of this equation by ${\bf b}_m$
we get
\begin{equation}
{\bf v}_m= {\bf v} \cdot {\bf b}_m=\sum_{\alpha=1}^3
{\bf v}_{\alpha} {\bf b}_{\alpha,m}.
\end{equation}

When a vector is given in Cartesian coordinates
(${\bf v}_{\alpha}$) we can write it in the basis of the primitive reciprocal lattice vectors:
\begin{equation}
{\bf v}= \sum_{l=1}^3 {\bf v}_l {\bf b}_l.
\end{equation}
Multiplying both members of this equation by ${\bf a}_m$
we get
\begin{equation}
{\bf v}_m= {\bf v} \cdot {\bf a}_m=\sum_{\alpha=1}^3
{\bf v}_{\alpha} {\bf a}_{\alpha,m}.
\end{equation}

When a vector is given in the basis of the primitive Bravais lattice vectors its Cartesian coordinates are
\begin{equation}
{\bf v}_\alpha= \sum_{l=1}^3 {\bf v}_l {\bf a}_{\alpha,l}.
\end{equation}

When a vector is given in the basis of the primitive reciprocal lattice vectors its Cartesian coordinates are
\begin{equation}
{\bf v}_\alpha= \sum_{l=1}^3 {\bf v}_l {\bf b}_{\alpha,l}.
\end{equation}

{\color{dark-blue}\chapter{Symmetry in self-consistent codes}}
\color{black}

\section{The Kohn and Sham wavefunctions}

We can consider the Bloch functions, solutions of the Kohn and Sham equations:
\begin{equation}
H_{KS} \psi_{{\bf k}, n}({\bf r})= \varepsilon_{{\bf k}, n}\psi_{{\bf k}, n} ({\bf r}),
\end{equation}
where ${\bf k}$ is a wave vector in the first Brillouin zone an $n$ is a band index.
For each element of the space group $\{S_i,{\bf a}_i\}$ we can associate an operator $O_{\{S_i,{\bf a}_i\}}$ that will rotate the Bloch functions. We require that after the rotation the new function $O_{\{S_i,{\bf a}_i\}} \psi_{{\bf k} n} ({\bf r})$ has in ${\bf r}$ the same value that the original function had in the point
${\bf r}'$ which after the rotation becomes ${\bf r}$.
We have 
\begin{equation}
{\bf r}'= \{S_i,{\bf a}_i\}^{-1} {\bf r}
\end{equation}
therefore
\begin{equation}
O_{\{S_i,{\bf a}_i\}} \psi_{{\bf k}, n} ({\bf r}) =
\psi_{{\bf k}, n} (\{S_i,{\bf a}_i\}^{-1} {\bf r}).
\end{equation}
Writing the Bloch functions in the form
\begin{equation}
\psi_{{\bf k}, n} ({\bf r}) = e^{i{\bf k} \cdot {\bf r}} u_{{\bf k}, n} ({\bf r}),
\end{equation}
where $u_{{\bf k}, n} ({\bf r})$ is a lattice periodic function, we have:
\begin{equation}
O_{\{S_i,{\bf a}_i\}} \psi_{{\bf k}, n} ({\bf r})
= e^{iS_i{\bf k} \cdot {\bf r}}e^{-iS_i{\bf k} \cdot {\bf a}_i} u_{{\bf k}, n} (\{S_i,{\bf a}_i\}^{-1} {\bf r}).
\label{psisik}
\end{equation}
Therefore, $O_{\{S_i,{\bf a}_i\}} \psi_{{\bf k}, n} ({\bf r})$ is a Bloch function with wave-vector $S_i {\bf k}$.
If $\{S_i,{\bf a}_i\}$ belongs to the solid space group, $O_{\{S_i,{\bf a}_i\}}$ commutes with $H_{KS}$
and $O_{\{S_i,{\bf a}_i\}} \psi_{{\bf k}, n} ({\bf r})$
is an eigenstate of the Hamiltonian with
eigenvalue $\varepsilon_{{\bf k}, n}$. We can call it $\psi_{S_i {\bf k},n} ({\bf r})$.

\section{The charge density in real space}

The charge density is calculated as a sum over the
Brillouin zone and the occupied bands:
\begin{equation}
n({\bf r}) = 2 \sum_{{\bf k}, v} |\psi_{{\bf k}, v} ({\bf r}) |^2,
\end{equation}
where the factor two accounts for spin degeneracy.
Usually we use a uniform grid $N_{k_1}\times N_{k_2} \times N_{k_3}$ of ${\bf k}$ of points to perform this sum, and we use a grid such that if we apply a rotation $S_i$ of the point group to a wave-vector ${\bf k}$ we obtain the wave-vector $S_i {\bf k}$ which is also a grid point. 
In these hypotheses, the set of wave vectors $S_i {\bf k}$ obtained by applying $S_i$ to all points of the grid
coincides with the original grid itself. Therefore we 
can write 
\begin{equation}
n({\bf r}) = {2 \over N_S} \sum_{i=1}^{N_S} \sum_{{\bf k}, v} |\psi_{S_i{\bf k}, v} ({\bf r}) |^2,
\end{equation}
where $N_S$ is the number of symmetries of the point group. Now each ${\bf k}$ in the mesh can be obtained from a ${\bf k}$ in the irreducible Brillouin zone (IBZ) by applying an appropriate rotation $S_l$.
We can write:
\begin{equation}
n({\bf r}) = {2 \over N_S} \sum_{i=1}^{N_S} \sum_{{\bf k} \in IBZ, v} \sum_l |\psi_{S_iS_l{\bf k}, v} ({\bf r}) |^2.
\end{equation}
The sum over ${\bf k}$ is limited to the IBZ and the sum over $l$ is over the $N_{\bf k}$ symmetries needed to obtain all the star of ${\bf k}$ from the 
${\bf k}$ in the IBZ. But now we can exchange the sum over $l$ and the sum over $i$ and notice that the sum over $i$ is over all the elements of the point group and for the rearrangement lemma the elements $\{ S_i S_l\}$ are still all the elements of the point group. It is convenient to introduce
a weight $w_{\bf k}$ that gives the number of points in the star of ${\bf k}$ so that we can write
\begin{equation}
n({\bf r}) = {2 \over N_S} \sum_{i=1}^{N_S}  \sum_{{\bf k} \in IBZ, v} w_{\bf k}\ |\psi_{S_i{\bf k}, v} ({\bf r}) |^2,
\end{equation}
Now we can use Eq.~\ref{psisik} and write
\begin{equation}
n({\bf r}) = {2 \over N_S} \sum_{i=1}^{N_S} \sum_{{\bf k}\in IBZ , v} w_{\bf k}\ |\psi_{{\bf k}, v} ( \{S_i,{\bf f}_i\}^{-1} {\bf r}) |^2,
\label{chargedensity}
\end{equation}
where we choose the spatial group operation $\{S_i,{\bf f}_i\}$ since Eq.~\ref{chargedensity} does not depend on
${\bf R}_{\mu_i}$.

The charge density is computed in two steps. First one computes the unsymmetrized charge density:
\begin{equation}
\tilde n({\bf r}) = 2 \sum_{{\bf k}\in IBZ , v} w_{\bf k}\ |\psi_{{\bf k}, v} ({\bf r}) |^2,
\label{unsymchden}
\end{equation}
and finally the charge density is symmetrized:
\begin{equation}
n({\bf r}) = {1 \over N_S} \sum_{i=1}^{N_S} \tilde n ( \{S_i,{\bf f}_i\}^{-1} {\bf r}).
\label{symchden}
\end{equation}
Since we are adding on all operations of the group, we obtain the same result applying $\{S_i,{\bf f}_i\}$ in Eq.~\ref{symchden}:
\begin{equation}
n({\bf r}) = {1 \over N_S} \sum_{i=1}^{N_S} \tilde n ( \{S_i,{\bf f}_i\} {\bf r}).
\label{symchden1}
\end{equation}

\section{The charge density in reciprocal space}
Eq.~\ref{symchden1} can be used to find a symmetrization formula in reciprocal space. Taking the Fourier transform at the reciprocal lattice vector ${\bf G}$ we have:
\begin{eqnarray}
n({\bf G}) &=& {1\over N_S} {1\over \Omega}
\sum_{i=1}^{N_S} \int_{\Omega} \tilde n ( \{S_i,{\bf f}_i\} {\bf r}) e^{-i{\bf G} \cdot {\bf r}} d^3r\nonumber \\
&=&{1\over N_S} {1\over \Omega}
\sum_{i=1}^{N_S} \int_{\Omega} \tilde n ({\bf r}) e^{-i{\bf G} \cdot \{S_i,{\bf f}_i\}^{-1}{\bf r}} d^3r \nonumber \\
&=&{1\over N_S} {1\over \Omega}
\sum_{i=1}^{N_S} \int_{\Omega} \tilde n ({\bf r}) e^{-i{\bf G} \cdot S_i^{-1}{\bf r}} e^{i{\bf G} \cdot S_i^{-1}{\bf f}_i} d^3r \nonumber \\
&=&{1\over N_S} {1\over \Omega}
\sum_{i=1}^{N_S} e^{iS_i {\bf G} \cdot {\bf f}_i} \int_{\Omega} \tilde n ({\bf r}) e^{-iS_i {\bf G} \cdot {\bf r}} d^3r \nonumber \\
&=&{1\over N_S}
\sum_{i=1}^{N_S} e^{iS_i {\bf G} \cdot {\bf f}_i}  \tilde n (S_i{\bf G}). 
\label{symng}
\end{eqnarray}
This formula could be applied for any ${\bf G}$ vector but it useful to observe that if we know $n({\bf G})$ we can find
$n(S_i{\bf G})$ with a simple formula.
Since after an operation of the space group $\{S_i,{\bf f}_i\}$ the solid does not change we must have:
\begin{equation}
n({\bf r})=n(\{S_i,{\bf f}_i\}{\bf r}).
\end{equation}
Doing a Fourier transform as shown above, from this formula we get
\begin{equation}
 n({\bf G})= e^{iS_i {\bf G} \cdot {\bf f}_i} n (S_i{\bf G}), 
\end{equation}
or 
\begin{equation}
 n(S_i{\bf G})= e^{-iS_i {\bf G} \cdot {\bf f}_i} n ({\bf G}). 
 \label{ngdist}
\end{equation}

\section{The forces}

Let us now consider a set of displacements of each atom of the solid. We indicate with ${\bf u}_{I}$ the displacement of the atom that in equilibrium is in
${\bf R}_I$. Suppose that we compute the total energy
with the atomic coordinates $\{{\bf R}_I + {\bf u}_I\}$.
If we do an opertion of the solid space group
$\{S_i,{\bf a}_i\}$ the atomic positions becomes
\begin{equation}
\{S_i,{\bf a}_i\} ({\bf R}_I + {\bf u}_I) = 
{\bf R}_{\bar I} + S_i {\bf u}_I.
\end{equation}
So if in the rotated solids we choose the displacements
\begin{equation}
{\bf u}'_{\bar I} =  S_i {\bf u}_I,
\label{rotated_disp}
\end{equation}
the energy cannot change and we can write:
\begin{equation}
E_{tot}\left(\{{\bf R}_I + {\bf u}_I\}\right) = E_{tot}\left (\{\{S_i,{\bf a}_i\} ({\bf R}_I + {\bf u}_I)\}\right )=
E_{tot}\left(\{ {\bf R}_{\bar I} + {\bf u}'_{\bar I}\}\right),
\end{equation}
and computing the derivatives with respect to ${\bf u}_{I,\alpha}$ we have:
\begin{equation}
{d E_{tot} \over d {\bf u}_{\mu,s,\alpha}} = \sum_{\beta=1}^3
{d E_{tot} \over d {\bf u}_{{\bar \mu},{\bar s},\beta}} 
{d {\bf u}_{{\bar \mu},{\bar s},\beta} \over
d {\bf u}_{\mu, s,\alpha}}=\sum_{\beta=1}^3
{d E_{tot} \over d {\bf u}_{{\bar \mu},{\bar s},\beta}} 
S_{i,\beta,\alpha}=\sum_{\beta=1}^3 S^{-1}_{i,\alpha,\beta}
{d E_{tot} \over d {\bf u}_{{\bar \mu},{\bar s},\beta}},
\end{equation}
where we used the fact that $S_{i,\alpha,\beta}$ is an orthogonal matrix.

This relation can be used by adding on all the operations of the point group $S_i$ and dividing by
$N_S$. In the left hand side that does not depend on
$S_i$ we obtain the symmetrised forces:
\begin{equation}
{\bf F}_{s,\alpha} ={1 \over N_S} \sum_{i=1}^{N_S} \sum_{\beta=1}^3 S^{-1}_{i,\alpha,\beta}
{\bf F}_{\bar s,\beta}.
\label{symforce}
\end{equation}
In the right-hand side, we can use the unsymmetrized
forces computed by doing a sum over the IBZ when
adding on ${\bf k}$.

Reasoning in the same way we can write a similar relationship for the second derivative of the energy with respect to two displacements:
\begin{equation}
{d^2 E_{tot} \over d {\bf u}_{\mu,s,\alpha} d {\bf u}_{\nu,s',\beta}} =
\sum_{\gamma=1}^3\sum_{\delta=1}^3  S^{-1}_{i,\alpha,\gamma} S^{-1}_{i,\beta,\delta}
{d^2 E_{tot} \over d {\bf u}_{{\bar \mu},{\bar s},\gamma}d {\bf u}_{{\bar \nu},{\bar s}',\delta} }.
\label{secondder}
\end{equation}

\section{The stress}
The stress is defined as the derivative of the total
energy with respect to strain:
\begin{equation}
\sigma_{\alpha,\beta} = {1\over V} {\partial E_{tot} \over \partial \varepsilon_{\alpha,\beta}}.
\end{equation}
If we rotate the solid with an operation $\{S,{\bf a}\}$ of the solid space group, the total energy does not change if we put a rotated strain. Since the strain is a second rank tensor we must put a strain
\begin{equation}
\varepsilon'_{\alpha,\beta}= \sum_{\gamma,\delta}S_{\alpha,\gamma} S_{\beta,\delta} \varepsilon_{\gamma,\delta}.
\end{equation}
With this strain we can write
\begin{equation}
E_{tot}\left(\{\varepsilon_{\alpha,\beta}\}\right) = 
E_{tot}\left(\{\varepsilon'_{\alpha,\beta}\}\right),
\end{equation}
and doing the derivatives we have:
\begin{equation}
{\partial E_{tot}\left(\{\varepsilon_{\alpha,\beta}\}\right) \over \partial \varepsilon_{\alpha,\beta}} =\sum_{\gamma,\delta=1}^3 {\partial 
E_{tot}\left(\{\varepsilon'_{\alpha,\beta}\}\right)
\over \partial \varepsilon'_{\gamma,\delta}} {\partial \varepsilon'_{\gamma,\delta} \over \partial \varepsilon_{\alpha,\beta}} = 
\sum_{\gamma,\delta=1}^3 S^{-1}_{\alpha,\gamma}
S^{-1}_{\beta,\delta}{\partial 
E_{tot}\left(\{\varepsilon'_{\alpha,\beta}\}\right)
\over \partial \varepsilon'_{\gamma,\delta}}. 
\end{equation}
Equivalently we can write:
\begin{equation}
\sigma_{\alpha,\beta}= 
\sum_{\gamma,\delta=1}^3 S^{-1}_{\alpha,\gamma}
S^{-1}_{\beta,\delta}
\sigma_{\gamma,\delta}.
\end{equation}
The working symmetrization formula is obtained adding on the $N_S$ symmetry operations of the point group
and dividing by $N_S$. We have:
\begin{equation}
\sigma_{\alpha,\beta}= {1 \over N_S} \sum_{i=1}^3
\sum_{\gamma,\delta=1}^3 S^{-1}_{i,\alpha,\gamma}
S^{-1}_{i,\beta,\delta}
\sigma_{\gamma,\delta}.
\label{symstress}
\end{equation}

{\color{dark-blue}\chapter{Symmetry in linear response codes}}
\color{black}

\section{Dynamical matrix}

The dynamical matrix is defined in term of the interatomic force constants by the relationship:
\begin{equation}
D_{s,\alpha,s',\beta}({\bf q}) =
{1 \over N \sqrt{M_s M_s'}} \sum_{\mu} \sum_{\nu}
e^{-i {\bf q} \cdot {\bf R}_\mu}
{d^2 E_{tot} \over d {\bf u}_{\mu,s,\alpha} d {\bf u}_{\nu,s',\beta}}
e^{i {\bf q} \cdot {\bf R}_\nu}
\end{equation}
We can insert a sum over $\bar \mu$ and a sum over
$\bar \nu$ and divide by $N^2$. We have
\begin{equation}
D_{s,\alpha,s',\beta}({\bf q}) =
{1 \over N^3 \sqrt{M_s M_s'}} \sum_{\mu,\bar \mu} \sum_{\nu,\bar \nu}
e^{-i {\bf q} \cdot ({\bf R}_\mu - S^{-1}{\bf R}_{\bar \mu}) }
e^{-i S {\bf q} \cdot {\bf R}_{\bar \mu}}
{d^2 E_{tot} \over d {\bf u}_{\mu,s,\alpha} d {\bf u}_{\nu,s',\beta}}
e^{i S {\bf q} \cdot {\bf R}_{\bar \nu}}
e^{i {\bf q} \cdot ({\bf R}_\nu - S^{-1}{\bf R}_{\bar \nu})}
\end{equation}
and now we can use Eq.\ref{secondder} to write
\begin{eqnarray}
D_{s,\alpha,s',\beta}({\bf q}) =
{1 \over N^3 \sqrt{M_s M_s'}} \sum_{\mu,\bar \mu, \nu,\bar \nu} \sum_{\gamma,\delta=1}^3  S^{-1}_{i,\alpha,\gamma} S^{-1}_{i,\beta,\delta}
e^{-i {\bf q} \cdot ({\bf R}_\mu - S^{-1}{\bf R}_{\bar \mu}) } \times \nonumber \\
e^{-i S{\bf q} \cdot {\bf R}_{\bar \mu}}
{d^2 E_{tot} \over d {\bf u}_{{\bar \mu},{\bar s},\gamma}d {\bf u}_{{\bar \nu},{\bar s}',\delta} }
e^{i S{\bf q} \cdot {\bf R}_{\bar \nu}}
e^{i {\bf q} \cdot ({\bf R}_\nu - S^{-1}{\bf R}_{\bar \nu})}
\end{eqnarray}
or
\begin{equation}
D_{s,\alpha,s',\beta}({\bf q}) =
{1 \over N^2 }\sum_{\mu, \nu} \sum_{\gamma,\delta=1}^3  S^{-1}_{i,\alpha,\gamma} S^{-1}_{i,\beta,\delta}
e^{-i {\bf q} \cdot ({\bf R}_\mu - S^{-1}{\bf R}_{\bar \mu}) }
D_{\bar s,\gamma,\bar s',\delta}(S{\bf q})
e^{i {\bf q} \cdot ({\bf R}_\nu - S^{-1}{\bf R}_{\bar \nu})}.
\end{equation}
If $\{S,{\bf a}\}$ is an operation of the solid space group we have:
\begin{equation}
\{S,{\bf a}\} ({\bf R}_\mu + \boldsymbol{\tau}_{s}) = 
S {\bf R}_\mu + S \boldsymbol{\tau}_{s} +{\bf a}=
{\bf R}_{\bar \mu} + \boldsymbol{\tau}_{\bar s},
\end{equation}
or
\begin{equation}
S {\bf R}_\mu -  {\bf R}_{\bar \mu} = - S \boldsymbol{\tau}_s + \boldsymbol{\tau}_{\bar s} - {\bf a},
\end{equation}
and
\begin{equation}
S {\bf R}_\nu -  {\bf R}_{\bar \nu} = - S \boldsymbol{\tau}_{s'} + \boldsymbol{\tau}_{\bar s'} - {\bf a}.
\end{equation}
Calling
\begin{equation}
{\bf R}^{S}_{\boldsymbol{\tau}_s} = S \boldsymbol{\tau}_{s} - \boldsymbol{\tau}_{\bar s},
\label{rstaus}
\end{equation}
we obtain the equation:
\begin{equation}
D_{s,\alpha,s',\beta}({\bf q}) =
\sum_{\gamma,\delta=1}^3  S^{-1}_{i,\alpha,\gamma} S^{-1}_{i,\beta,\delta}
e^{i S {\bf q} \cdot {\bf R}^{S}_{\boldsymbol{\tau}_s} }
D_{\bar s,\gamma,\bar s',\delta}(S{\bf q})
e^{-i S{\bf q} \cdot {\bf R}^{S}_{\boldsymbol{\tau}_{s'}}}.
\label{symdyn0}
\end{equation}
This expression tell us the equations satisfied by the dynamical matrix elements.
Its inverse can be obtained easily
\begin{equation}
D_{\bar s,\alpha,\bar s',\beta}(S{\bf q}) =
\sum_{\gamma,\delta=1}^3  S_{i,\alpha,\gamma} S_{i,\beta,\delta}
e^{-i {\bf q} \cdot {\bf R}^{S}_{\boldsymbol{\tau}_s} }
D_{s,\gamma,s',\delta}({\bf q})
e^{i {\bf q} \cdot {\bf R}^{S}_{\boldsymbol{\tau}_{s'}}},
\label{dynmat_inv}
\end{equation}
and gives as an equation to find the dynamical matrix at $S{\bf q}$ if we know the dynamical matrix at
${\bf q}$.
Eq.~\ref{symdyn0} can be used in the form:
\begin{equation}
D_{s,\alpha,s',\beta}({\bf q}) ={1\over N_S}
\sum_{i=1}^{N_S}
\sum_{\gamma,\delta=1}^3  S^{-1}_{i,\alpha,\gamma} S^{-1}_{i,\beta,\delta}
e^{i S {\bf q} \cdot {\bf R}^{S}_{\boldsymbol{\tau}_s} }
\tilde D_{\bar s,\gamma,\bar s',\delta}(S{\bf q})
e^{-i S{\bf q} \cdot {\bf R}^{S}_{\boldsymbol{\tau}_{s'}}},
\label{symdyn1}
\end{equation}
to symmetrize a dynamical matrix obtained by doing sums over the ${\bf k}$ points in the IBZ. Usually in this case we reduce the ${\bf k}$ points using only the symmetries of the small cogroup of ${\bf q}$ that is only the rotations for which
\begin{equation}
S {\bf q} = {\bf q} + {\bf G}_S
\end{equation}
where ${\bf G}_S$ is a reciprocal lattice vectors.
Eq.~\ref{symdyn1} simplifies as:
\begin{equation}
D_{s,\alpha,s',\beta}({\bf q}) ={1\over N_{S_{\bf q}}}
\sum_{i=1}^{N_{S_{\bf q}}}
\sum_{\gamma,\delta=1}^3  S^{-1}_{i,\alpha,\gamma} S^{-1}_{i,\beta,\delta}
\tilde D_{\bar s,\gamma,\bar s',\delta}({\bf q})
e^{i {\bf q} \cdot \left( {\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}} \right) },
\label{symdyn2}
\end{equation}
where we used the fact that the dynamical matrix as a function of ${\bf q}$ is periodic with the periodicity of the reciprocal lattice, and
${\bf R}^{S}_{\boldsymbol{\tau}_s}+{\bf a}$ is a
Bravais lattice vector.

Also Eq.~\ref{dynmat_inv} can be specialized to the symmetries of the small cogroup of ${\bf q}$
\begin{equation}
D_{\bar s,\alpha,\bar s',\beta}({\bf q}) =
\sum_{\gamma,\delta=1}^3  S_{i,\alpha,\gamma} S_{i,\beta,\delta}
D_{s,\gamma,s',\delta}({\bf q})
e^{-i {\bf q} \cdot ({\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}})},
\label{dynmat_inv_smallq}
\end{equation}
and used to calculate all the matrix elements  
$D_{\bar s,\alpha,\bar s',\beta}({\bf q})$ once
we have calculated 
$D_{s,\alpha,s',\beta}({\bf q})$ with Eq.~\ref{symdyn2}.

\subsection{Eigenvectors of the dynamical matrix}
We have seen (in the section on forces) how the displacements in the rotated system are related to those in the original solid. We can find also the relationship between the eigenvectors of the dynamical matrix in the rotated system. A phonon displacement has
the form:
\begin{equation}
{\bf u}_{\mu,s,\alpha}= {\bf u}_{s,\alpha}({\bf q}) e^{i{\bf q}\cdot {\bf R}_\mu}.
\end{equation}
In the rotated system we must have a similar equation
\begin{equation}
{\bf u}'_{{\bar \mu},{\bar s},\alpha}= {\bf u}'_{{\bar s},\alpha}({\bf q}') e^{i{\bf q}'\cdot {\bf R}_{\bar \mu}}= \sum_{\beta=1}^3 S_{\alpha,\beta} {\bf u}_{\mu,s,\beta} = \sum_{\beta=1}^3 S_{\alpha,\beta} {\bf u}_{s,\beta}({\bf q}) e^{i{\bf q}\cdot {\bf R}_\mu}
\label{u1}.
\end{equation}
We can rewrite this equation in the form
\begin{equation}
{\bf u}'_{{\bar \mu},{\bar s},\alpha}= {\bf u}'_{{\bar s},\alpha}({\bf q}') e^{i{\bf q}'\cdot {\bf R}_{\bar \mu}}= \sum_{\beta=1}^3 S_{\alpha,\beta} {\bf u}_{s,\beta}({\bf q}) 
e^{iS {\bf q}\cdot {\bf R}_{\bar \mu} }
e^{i{\bf q}\cdot ({\bf R}_\mu - S^{-1} {\bf R}_{\bar \mu}) }, 
\label{u1}
\end{equation}
and using the quantity ${\bf R}^S_{\boldsymbol{\tau}_s}$ (see Eq.~\ref{rstaus}), we can write
Eq.~\ref{u1} as 
\begin{equation}
{\bf u}'_{{\bar s},\alpha}({\bf q}') e^{i{\bf q}'\cdot {\bf R}_{\bar \mu}}=\sum_{\beta=1}^3 S_{\alpha,\beta} {\bf u}_{s,\beta}({\bf q}) e^{iS {\bf q}\cdot {\bf R}_{\bar \mu}} e^{-i S {\bf q} \cdot \left({\bf R}^S_{\boldsymbol{\tau}_s} + {\bf a} \right)}.
\end{equation}
This shows that ${\bf q}'=S {\bf q}$ and 
\begin{equation}
{\bf u}'_{{\bar s},\alpha}(S {\bf q}) 
= \sum_{\beta=1}^3 S_{\alpha,\beta} {\bf u}_{s,\beta}({\bf q}) e^{-iS {\bf q} \cdot 
{\bf R}^S_{\boldsymbol{\tau}_s}}
e^{-iS {\bf q} \cdot {\bf a}}.
\end{equation}

\section{The charge density induced by a phonon}

To symmetrize the charge density induced by a phonon perturbation we consider a space-group operation $\{S,{\bf a}\}$
and the charge density in the rotated system. If
we look in the point $\{S,{\bf a}\} {\bf r}$ in the rotated system we should have the same charge as in the 
point ${\bf r}$ in the original system provided that we use Eq.~\ref{rotated_disp} for the displacements.
Therefore
\begin{equation}
n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
=n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right).
\end{equation}
Deriving with respect to ${\bf u}_{\mu,s,\alpha}$ we get
\begin{eqnarray}
{d n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{\mu,s,\alpha}}
&=&\sum_{\beta=1}^3 {d n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar \mu,\bar s,\beta}} {d {\bf u}_{\bar \mu,\bar s,\beta} \over  
d {\bf u}_{\mu,s,\alpha} } \nonumber \\
&=& \sum_{\beta=1}^3 S^{-1}_{\alpha,\beta} {d n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar \mu,\bar s,\beta}}.
\label{dnmu}
\end{eqnarray}
The charge density induced by a phonon of wave vector ${\bf q}$ is given by
\begin{equation}
{d n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})} =
\sum_\mu {d n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{\mu,s,\alpha}} e^{i{\bf q}\cdot {\bf R}_\mu},
\end{equation}
and using Eq.~\ref{dnmu} we obtain:
\begin{eqnarray}
{d n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})} &=&
{1\over N}\sum_{\mu,\bar \mu} \sum_{\beta=1}^3 S^{-1}_{\alpha,\beta} {d n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar \mu,\bar s,\beta}}e^{iS{\bf q}\cdot {\bf R}_{\bar \mu} } e^{i{\bf q}\cdot ({\bf R}_\mu - S^{-1}{\bf R}_{\bar \mu}) } \nonumber \\
&=& \sum_{\beta=1}^3 S^{-1}_{\alpha,\beta} {d n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar s,\beta} (S{\bf q})} e^{-iS{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}} e^{-iS{\bf q}\cdot {\bf a}},
\end{eqnarray}
where ${\bf R}^S_{{\boldsymbol{\tau}_s}}$ is defined in Eq.~\ref{rstaus}. 

This expression can be simplified if we use it for rotations that belong to the small cogroup of {\bf q}, such that $S{\bf q}={\bf q}+{\bf G}_S$.
Since ${\bf R}^S_{{\boldsymbol{\tau}_s}}+{\bf a}$ is a lattice vector we have
\begin{equation}
{d n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})} = \sum_{\beta=1}^3 S^{-1}_{\alpha,\beta} {d n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar s,\beta} ({\bf q})} e^{-i{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}} e^{-i{\bf q}\cdot {\bf a}}.
\end{equation}
The charge density induced by a phonon can be written as:
\begin{equation}
{d n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})} = 
e^{i {\bf q} \cdot {\bf r}} {d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})},
\end{equation}
where ${d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})}$ is a lattice periodic function.
We need to symmetrize only the lattice periodic
part of the induced charge density, so we have
\begin{equation}
{d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})} 
= e^{-i{\bf q} \cdot {\bf r}}
e^{i{\bf q}\cdot (S {\bf r} + {\bf a})}
\sum_{\beta=1}^3 S^{-1}_{\alpha,\beta} {d \tilde n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar s,\beta} ({\bf q})} e^{-i{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}} e^{-i{\bf q}\cdot {\bf a}}.
\end{equation}
This equation can be written also as 
\begin{equation}
{d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})} 
= e^{i{\bf G}_{S^{-1}} \cdot {\bf r}}
\sum_{\beta=1}^3 S^{-1}_{\alpha,\beta} {d \tilde n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar s,\beta} ({\bf q})} e^{-i{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}}.
\label{symdrho}
\end{equation}
This equation is further transformed before implementation (see the Appendix on irrep).

\section{The charge density induced by an electric field}
Reasoning as above we can say that if $\{S,{\bf a}\}$ is a space group operation the charge density
at the point ${\bf r}$ when there is an electric field ${\bf E}$ is equal to the charge density at the rotated point  $\{S,{\bf a}\}{\bf r}$ when the electric field
is ${\bf E}'=S {\bf E}$. Therefore
\begin{equation}
n\left({\bf r}, {\bf E}\right)
=n\left(\{S,{\bf a}\} {\bf r}, {\bf E}'\right), 
\end{equation}
and deriving with respect to ${\bf E}_\alpha$ we get
\begin{equation}
{d n\left({\bf r}, {\bf E}\right)
\over d {\bf E}_\alpha }=\sum_{\beta=1}^3 S^{-1}_{\alpha,\beta} {d n\left(\{S,{\bf a}\} {\bf r}, {\bf E}'\right)
\over d {\bf E}'_\beta }.
\end{equation}

\section{The dielectric constant}
The dielectric constant can be written as 
\begin{equation}
\epsilon_{\alpha,\beta}=\delta_{\alpha,\beta} -{4 \pi
\over V} {\partial^2 E_{tot} ({\bf E}) \over \partial {\bf E}_\alpha \partial {\bf E}_\beta}.
\end{equation}
If we now consider an operation $\{S,{\bf a}\}$ of the solid space group and rotate the electric field to ${\bf E}'=S{\bf E}$, the total energy in the rotated system does not change. We have therefore:
\begin{equation}
{\partial^2 E_{tot} ({\bf E}) \over \partial {\bf E}_\alpha \partial {\bf E}_\beta}=\sum_{\gamma,\delta=1}^3
S^{-1}_{\alpha,\gamma} S^{-1}_{\beta,\delta}
{\partial^2 E_{tot} ({\bf E}') \over \partial {\bf E}'_\gamma \partial {\bf E}'_\delta},
\end{equation}
or equivalently we can write
\begin{equation}
\epsilon_{\alpha,\beta}=\sum_{\gamma,\delta=1}^3
S^{-1}_{\alpha,\gamma} S^{-1}_{\beta,\delta}
\epsilon_{\gamma,\delta}.
\end{equation}
The working symmetrization formula is obtained adding on the $N_S$ symmetry operations of the point group
and dividing by $N_S$. We have:
\begin{equation}
\epsilon_{\alpha,\beta}= {1 \over N_S} \sum_{i=1}^3
\sum_{\gamma,\delta=1}^3 S^{-1}_{i,\alpha,\gamma}
S^{-1}_{i,\beta,\delta}
\epsilon_{\gamma,\delta}.
\label{symepsilon}
\end{equation}


\section{The Born effective charges}
Born effective charges are second derivative of the total energy with respect to phonon displacements and electric field component:
\begin{equation}
qZ^*_{s,\alpha,\beta}= {1\over N} {\partial E_{tot} \over \partial {\bf u}_{s,\alpha} \partial {\bf E}_\beta}.
\end{equation}

So we use the fact that for an operation $\{S,{\bf a}\}$ of the point group of the solid in which the atoms goes in $\{S,{\bf a}\} ({\bf R}_I+{\bf u}_I)$ and the electric field becomes 
${\bf E}'=S{\bf E}$ the total energy should not change.
\begin{equation}
E_{tot}(\{{\bf R}_I+{\bf u}_I\},{\bf E}) =
E_{tot}(\{\{S,{\bf a}\}({\bf R}_I+{\bf u}_I)\},{\bf E}'),
\end{equation}
and performing the derivatives we have:
\begin{equation}
{\partial E_{tot}(\{{\bf R}_I+{\bf u}_I\},{\bf E}) \over  \partial {\bf u}_{s,\alpha} \partial {\bf E}_\beta} = \sum_{\gamma,\delta} S^{-1}_{\alpha,\gamma} S^{-1}_{\beta,\delta} {\partial 
E_{tot}(\{\{S,{\bf a}\}({\bf R}_I+{\bf u}_I)\},{\bf E}')
\over \partial {\bf u}_{\bar s,\gamma} \partial {\bf E}'_\delta},
\end{equation}
or equivalently
\begin{equation}
Z^*_{s,\alpha,\beta}
= \sum_{\gamma,\delta} S^{-1}_{\alpha,\gamma} S^{-1}_{\beta,\delta} 
Z^*_{\bar s,\gamma,\delta}.
\end{equation}

\newpage
{\color{dark-blue}\chapter{Appendices}}
\color{black}
The main symmetry variables available in Quantum ESPRESSO and their relationship with the symbol used in these notes are

\begin{itemize}

\item
\texttt{at(3,3)} contains the principal lattice vectors ${\bf a}_{\alpha,i}$ with this order for the two indices (the first is cartesian, the second indicates the vector). 

\item
\texttt{bg(3,3)} contains the principal reciprocal lattice vectors ${\bf b}_{\alpha,i}$ with this order for the two indices (the first is cartesian, the second indicates the vector).

\item 
\texttt{nsym} is $N_S$ the number of symmetry operations of the point group.

\item
\texttt{s(3,3,48)} contains $S_{i,l,m}$. The symmetry index $i$ is the third, while $l,m$ are the first two indices.

\item
\texttt{sr(3,3,48)} contains $S_{i,\alpha,\beta}$, the rotation matrices in Cartesian coordinates.

\item
\texttt{ft(3,48)} contains $-{\bf f}_i$ the fractional translation with the negative sign.
It is in crystal coordinates of the principal lattice vector. The symmetry index $i$ is the second.

\item
\texttt{invs(48)} for each symmetry $i$ gives the index of the inverse of $S_i$.

\item
\texttt{irt(48,nat)} for each atom $s$ and symmetry $i$ gives the index of the atom $\bar s$.

\item 
\texttt{nsymq} is $N_{S_{\bf q}}$ the number of symmetry operations of the point cogroup of the
{\bf q} point.

\item 
\texttt{rtau(3,48,nat)} contains ${\bf R}^{S_i}_{\boldsymbol{\tau}_s}$ (see Eq.~\ref{rstaus}) in Cartesian coordinates.

\item
\texttt{gi(3,48)} The vector ${\bf G}_{S_i^{-1}}$
associated to each symmetry $S_i^{-1}{\bf q}={\bf q}+{\bf G}_{S_i^{-1}}$.

\end{itemize}


\section{Appendix: Symvector} 
This routine should apply Eq.~\ref{symforce}. It 
actually calculates 
\begin{equation}
{\bf F}_{s,\alpha} ={1 \over N_S} \sum_{i=1}^{N_S} \sum_{\beta, \delta, \epsilon, l, m} {\bf b}_{\alpha,l} {\bf a}_{\epsilon,l} S^{-1}_{i,\epsilon,\beta} {\bf b}_{\beta,m} {\bf a}_{\delta,m}
{\bf F}_{\bar s,\delta},
\label{symforceapp1}
\end{equation}
obtained introducing two delta functions in Eq.~\ref{symforce}. The sum on $\delta$ in the last two terms gives the unsymmetrized forces in the basis of the
reciprocal primitive vectors ${\bf F}_{{\bar s},m}$ and
using Eq.~\ref{slj} to make the sum over {$\beta$ and $\epsilon$} we can write 
\begin{equation}
{\bf F}_{s,\alpha} ={1 \over N_S} \sum_{i=1}^{N_S} \sum_{l, m} {\bf b}_{\alpha,l} S_{i,l,m}  {\bf F}_{\bar s,m},
\label{symforceapp2}
\end{equation}
which is the expression implemented in this routine.

\section{Appendix: Symmatrix}
This routine symmetrizes $3\times 3$ matrices such as the stress or the dielectric constants. These two quantities can be symmetrized with the same formula
(see Eq.~\ref{symstress} and \ref{symepsilon}).
We write the espression for stress:
\begin{equation}
\sigma_{\alpha,\beta}={1 \over N_S} \sum_{i=1}^{N_S}
\sum_{\gamma, \delta, \epsilon, \eta, \nu, \rho} \sum_{l, m, n, p} {\bf b}_{\alpha,l} {\bf a}_{\epsilon,l} S^{-1}_{i,\epsilon,\eta} {\bf b}_{\eta,m} {\bf a}_{\gamma,m} {\bf b}_{\beta,n} {\bf a}_{\nu,n} S^{-1}_{i,\nu,\rho} {\bf b}_{\rho,p} {\bf a}_{\delta,p} \sigma_{\gamma,\delta}.
\end{equation}
The sum over $\gamma$ and $\delta$ give the stress in the basis of the primitive reciprocal vectors
\begin{equation}
\sigma_{m,p}=\sum_{\gamma, \delta=1}^3
{\bf a}_{\gamma,m} {\bf a}_{\delta,p} \sigma_{\gamma,\delta},
\label{smp}
\end{equation}
and Eq.~\ref{slj} used twice to do the sums over $\epsilon$, $\eta$, $\nu$ and $\rho$ gives
\begin{equation}
\sigma_{\alpha,\beta}={1 \over N_S} \sum_{i=1}^{N_S}
 \sum_{l, m, n, p} {\bf b}_{\alpha,l} {\bf b}_{\beta,n}S_{i,l,m} S_{i,n,p} \sigma_{m,p}.
\end{equation}

\section{Appendix: Symtensor}
With the same logic seen for the two previous routines, 
we find the expression used for symmetrizing the
Born effective charges by this routine
\begin{equation}
Z^*_{s,\alpha,\beta}={1 \over N_S} \sum_{i=1}^{N_S}
 \sum_{l, m, n, p} {\bf b}_{\alpha,l} {\bf b}_{\beta,n}S_{i,l,m} S_{i,n,p} Z^*_{\bar s,m,p},
\end{equation}
where 
\begin{equation}
Z^*_{\bar s,m,p} = \sum_{\gamma, \delta=1}^3 {\bf a}_{\gamma,m} {\bf a}_{\delta,p} Z^*_{\bar s,\gamma,\delta}
\end{equation}
is the Born effective charge written in the basis of the primitive reciprocal lattice vectors.

\section{Appendix: Crys\_to\_cart}
This routine receives a rank-two tensor in Cartesian coordinates and transforms it into a tensor in the basis of the primitive reciprocal vectors. It implements the Eq.~\ref{smp}:
\begin{equation}
\sigma_{m,p}=\sum_{\gamma, \delta=1}^3
{\bf a}_{\gamma,m} {\bf a}_{\delta,p} \sigma_{\gamma,\delta}.
\end{equation}

\section{Appendix: Cart\_to\_crys}
This routine receives a rank-two tensor in the basis of the primitive reciprocal lattice and transforms it into a tensor in Cartesian coordinates. It implements the equation:
\begin{equation}
\sigma_{\alpha,\beta}=\sum_{m,p=1}^3
{\bf b}_{\alpha,m} {\bf b}_{\beta,p} \sigma_{m,p}.
\end{equation}

\section{Appendix: Rotate\_grid\_point}

This routine receives the three integers
\texttt{(i,j,k)} that represent the point:
\begin{equation}
{\bf r}_{i,j,k}= {(i-1) \over N_1} {\bf a}_1 +
{(j-1) \over N_2} {\bf a}_2 +
{(k-1) \over N_3} {\bf a}_3,
\end{equation}
where $N_1$, $N_2$, and $N_3$ are the sizes of the FFT mesh and gives as output the three integers
\texttt{(ri,rj,rk)} that represent the point
${\bf r}'_{ri,rj,rk}=S {\bf r}_{i,j,k}+{\bf f}$ with
\begin{equation}
{\bf r}'_{ri,rj,rk}= {(ri-1) \over N_1} {\bf a}_1 +
{(rj-1) \over N_2} {\bf a}_2 +
{(rk-1) \over N_3} {\bf a}_3.
\end{equation}
Using Eq.~\ref{rotvcry}, we obtain:
\begin{eqnarray}
{(ri-1) \over N_1} &=& S_{1,1} {(i-1) \over N_1}+
S_{2,1} {(j-1) \over N_2} + S_{3,1} {(k-1) \over N_3} + {\bf f}_1, \nonumber \\
{(rj-1) \over N_2} &=& S_{1,2} {(i-1) \over N_1}+
S_{2,2} {(j-1) \over N_2} + S_{3,2} {(k-1) \over N_3} + {\bf f}_2, \nonumber \\
{(rk-1) \over N_3} &=& S_{1,3} {(i-1) \over N_1}+
S_{2,3} {(j-1) \over N_2} + S_{3,3} {(k-1) \over N_3} + {\bf f}_3, 
\end{eqnarray}
which can be rewritten as
\begin{eqnarray}
ri-1 &=& S_{1,1} (i-1) +
{S_{2,1} N_1 \over N_2} (j-1) + {S_{3,1} N_1 \over N_3} (k-1) + {\bf f}_1 N_1, \nonumber \\
rj-1 &=& {S_{1,2} N_2 \over N_1} (i-1)+
S_{2,2} (j-1) + {S_{3,2} N_2 \over N_3}(k-1) + {\bf f}_2 N_2, \nonumber \\
rk-1 &=& {S_{1,3} N_3 \over N_1} (i-1) +
{S_{2,3} N_3 \over N_2}(j-1) + S_{3,3} (k-1)  + {\bf f}_3 N_3. 
\end{eqnarray}
The routine \texttt{scale\_sym\_ops} updates the coefficients of the matrix $S$ which are given in input to this routine. 

\section{Appendix: Sym\_rho\_serial}

This routine first applies Eq.~\ref{symng} to save in \texttt{rhosum} the symmetrized charge density, and then uses Eq.~\ref{ngdist} to distribute the results to all the components
$S_i {\bf G}$. ${\bf G}$ is transformed in the basis of the principal reciprocal lattice 
vectors and it is rotated with Eq.~\ref{rotreccomp}, so actually the rotation
\texttt{ns} is applied not its inverse. \texttt{ft} is transformed in crystal coordinates at the beginning of the routine and the vector $S_i {\bf G}$ is actually \texttt{g\_(:,igs)}. Note also that \texttt{ft} contains $-{\bf f}_i$ so the
applied phase is actually $e^{iS_i{\bf G}\cdot {\bf f}}$ as written in Eq.~\ref{symng}.

\section{Appendix: The irrep}
In the phonon code we do not calculate derivatives of the charge density with respect to 
${\bf u}_{s,\alpha}({\bf q})$, but linear combinations of these derivatives that transform as irreducible representations of the small space group of ${\bf q}$. 

Suppose these linear combinations are given by $3\times N_{at}$ vectors $A^{p}_{s,\alpha}$, where
$1\le p \le 3 \times N_{at}$. These vectors are obtained in the code as eigenvectors of a random matrix which is symmetrized as the dynamical matrix according to Eq.~\ref{symdyn2}. These vectors are orthogonal, form a complete set, and are a basis for irreducible representations of the small co-group of ${\bf q}$.
Orthogonality means that
\begin{equation}
\sum_{s,\alpha} A^{*,p}_{s,\alpha} A^{q}_{s,\alpha}=\delta^{p,q}.
\end{equation}
Completeness means that
\begin{equation}
\sum_{p} A^{p}_{s,\alpha} A^{*,p}_{s',\beta}=\delta_{s,s'} \delta_{\alpha,\beta}.
\end{equation}
Making linear combinations of Eq.~\ref{symdrho}
we get
\begin{eqnarray}
\sum_{s,\alpha} A^p_{s,\alpha} {d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})} 
&=& e^{i{\bf G}_{S^{-1}} \cdot {\bf r}}
\sum_{s,\alpha}
\sum_{\beta=1}^3 A^p_{s,\alpha} S^{-1}_{\alpha,\beta} {d \tilde n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar s,\beta} ({\bf q})} e^{-i{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}}\nonumber \\
&=& e^{i{\bf G}_{S^{-1}} \cdot {\bf r}}
\sum_{q,s,\alpha, \bar{\bar s},\gamma,\beta} A^p_{s,\alpha} S^{-1}_{\alpha,\beta} e^{-i{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}} A^{*,q}_{\bar s,\beta} A^q_{\bar {\bar s},\gamma} {d \tilde n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right)
\over d {\bf u}_{\bar {\bar s},\gamma} ({\bf q})}. \nonumber \\
\label{symdrhop}
\end{eqnarray}
Defining the charge induced by the irreducible mode $\lambda^p$ as:
\begin{equation}
{d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d \lambda^p}=
\sum_{s,\alpha} A^p_{s,\alpha} {d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right)
\over d {\bf u}_{s,\alpha}({\bf q})},
\end{equation}
the rotation matrix
\begin{equation}
t_{q,p}^S=
\sum_{s,\alpha}
\sum_{\beta=1}^3 A^p_{s,\alpha} S^{-1}_{\alpha,\beta} e^{-i{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}} A^{*,q}_{\bar s,\beta} = \sum_{s,\alpha}
\sum_{\beta=1}^3 A^{*,q}_{\bar s,\beta} S_{\beta,\alpha} e^{-i{\bf q}\cdot {\bf R}^S_{{\boldsymbol{\tau}_s}}} A^p_{s,\alpha} ,
\end{equation}
we have the relationship:
\begin{equation}
{d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right) \over d \lambda^p} = e^{i{\bf G}_{S^{-1}} \cdot {\bf r}}
\sum_q t_{q,p}^S {d \tilde n\left(\{S,{\bf a}\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right) \over d \lambda^q}. 
\end{equation}
This equation is implemented by summing on all symmetry operations of the small cogroup of
{\bf q} and dividing by their number:
\begin{equation}
{d \tilde n\left({\bf r}, \{{\bf R}_I + {\bf u}_I\}\right) \over d \lambda^p} = {1\over N_{S_{\bf q}}} \sum_{i=1}^{N_{S_{\bf q}}} e^{i{\bf G}_{S_i^{-1}} \cdot {\bf r}}
\sum_q t_{q,p}^{S_i} {d \tilde n\left(\{S_i,{\bf a}_i\} {\bf r}, \{{\bf R}_{\bar I} + {\bf u}_{\bar I}\}\right) \over d \lambda^q}. 
\end{equation}

\section{Appendix: Dynamical matrix in the basis of irrep}
Given the eigenvalue equation that gives the phonon frequencies and the vibrational modes:
\begin{equation}
\sum_{s',\beta} D_{s,\alpha,s',\beta}({\bf q})
{\bf u}_{s',\beta}({\bf q})
= \omega^2({\bf q}) {\bf u}_{s,\alpha}({\bf q}),
\end{equation}
we can change the basis using the irrep. Multiplying the equation by $A^{*,p}_{s,\alpha}$ we get
\begin{equation}
\sum_q \sum_{s,\alpha} \sum_{s',\beta} \sum_{s'',\gamma} A^{*,p}_{s,\alpha} D_{s,\alpha,s',\beta}({\bf q})
A^{q}_{s',\beta} A^{*,q}_{s'',\gamma}
{\bf u}_{s'',\gamma}({\bf q})
= \omega^2({\bf q}) \sum_{s,\alpha} A^{*,p}_{s,\alpha}{\bf u}_{s,\alpha}({\bf q}),
\end{equation}
and defining the dynamical matrix in the basis of the irrep:
\begin{equation}
D_{p,q}({\bf q}) =\sum_{s,\alpha} \sum_{s',\beta} A^{*,p}_{s,\alpha} D_{s,\alpha,s',\beta}({\bf q}) A^{q}_{s',\beta},
\label{rotate_pattern_add}
\end{equation}
and the new modes:
\begin{equation}
{\bf u}_{q}({\bf q}) = \sum_{s'',\gamma} A^{*,q}_{s'',\gamma}
{\bf u}_{s'',\gamma}({\bf q}),
\end{equation}
the equation for phonon frequencies can be rewritten as:
\begin{equation}
\sum_q  D_{p,q}({\bf q})
{\bf u}_{q}({\bf q})
= \omega^2({\bf q}){\bf u}_{p}({\bf q}).
\end{equation}

We can also write the equation that transforms the dynamical matrix from the basis of the irrep to the Cartesian basis inverting Eq.~\ref{rotate_pattern_add}:
\begin{equation}
D_{s,\alpha,s',\beta}({\bf q}) =\sum_{p,q}  A^{p}_{s,\alpha} D_{p,q}({\bf q}) A^{*,q}_{s',\beta}.
\label{dyn_pattern_to_cart}
\end{equation}

\section{Appendix: symdynph\_gq}
This routine uses the Eqs.~\ref{symdyn2} and
\ref{dynmat_inv_smallq} to symmetryze the dynamical matrix. We can rewrite Eq.~\ref{symdyn2} in the basis of the primitive reciprocal lattice vectors inserting four
$\delta$ in it:
\begin{eqnarray}
D_{s,\alpha,s',\beta}({\bf q}) &=& {1\over N_{S_{\bf q}}}
\sum_{i=1}^{N_{S_{\bf q}}}
\sum_{m,n,o,p}
\sum_{\gamma,\delta,\eta,\lambda,\nu,\rho}
{\bf b}_{\alpha,m} {\bf a}_{\eta,m}
S_{i,\lambda,\eta} {\bf b}_{\lambda,n} {\bf a}_{\gamma,n}  {\bf b}_{\beta,o} {\bf a}_{\nu,o} S_{i,\rho,\nu} {\bf b}_{\rho,p} {\bf a}_{\delta,p}
\tilde D_{\bar s,\gamma,\bar s',\delta}({\bf q})
e^{i {\bf q} \cdot \left( {\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}} \right) }
\nonumber\\
&=& {1\over N_{S_{\bf q}}}
\sum_{i=1}^{N_{S_{\bf q}}}
\sum_{m,n,o,p}
\sum_{\gamma, \delta}
{\bf b}_{\alpha,m} {\bf b}_{\beta,o}
S_{i,m,n} S_{i,o,p} {\bf a}_{\gamma,n} {\bf a}_{\delta,p}
\tilde D_{\bar s,\gamma,\bar s',\delta}({\bf q})
e^{i {\bf q} \cdot \left( {\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}} \right)}.
\label{symdyn2_crys}
\end{eqnarray}
The routine receives as input the dynamical matrix in the basis of the primitive reciprocal lattice vectors: 
\begin{equation}
\tilde D_{s,n,s',p}({\bf q})
=\sum_{\gamma, \delta} {\bf a}_{\gamma,n} {\bf a}_{\delta,p}
\tilde D_{s,\gamma,s',\delta}({\bf q}),
\end{equation}
computes 
\begin{equation}
D_{s,m,s',o}({\bf q})
={1\over N_{S_{\bf q}}}
\sum_{i=1}^{N_{S_{\bf q}}}
\sum_{n,p}
S_{i,m,n} S_{i,o,p}
\tilde D_{\bar s,n,\bar s',p}({\bf q})
e^{i {\bf q} \cdot \left( {\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}} \right)}. 
\end{equation}

This symmetrized dynamical matrix in the basis
of the primitive reciprocal lattice vectors 
can be assigned to all elements $\bar s, \bar s'$.
To do this we can use Eq.~\ref{dynmat_inv_smallq}
and write it in the basis of the primitive reciprocal lattice vectors:
\begin{eqnarray}
D_{\bar s,\alpha,\bar s',\beta}({\bf q}) &=&
\sum_{m,n,o,p} \sum_{\gamma,\delta,\eta,\lambda,\nu,\rho} {\bf b}_{\alpha,m} {\bf a}_{\eta,m} S^{-1}_{i,\lambda,\eta} {\bf b}_{\lambda,n} {\bf a}_{\gamma,n} {\bf b}_{\beta,o} {\bf a}_{\nu,o}  S^{-1}_{i,\rho,\nu} {\bf b}_{\rho,p} {\bf a}_{\delta,p}
D_{s,\gamma,s',\delta}({\bf q})
e^{-i {\bf q} \cdot ({\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}})} \nonumber \\
&=& \sum_{m,n,o,p} \sum_{\gamma,\delta} {\bf b}_{\alpha,m} {\bf b}_{\beta,o}  S^{-1}_{i,m,n}    S^{-1}_{i,o,p} {\bf a}_{\gamma,n} {\bf a}_{\delta,p}
D_{s,\gamma,s',\delta}({\bf q})
e^{-i {\bf q} \cdot ({\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}})}, 
\label{dynmat_inv_smallq_rec}
\end{eqnarray}
or
\begin{equation}
D_{\bar s,m,\bar s',o}({\bf q}) =
\sum_{n,p}  S^{-1}_{i,m,n}    S^{-1}_{i,o,p} 
D_{s,n,s',p}({\bf q})
e^{-i {\bf q} \cdot ({\bf R}^{S}_{\boldsymbol{\tau}_s} - {\bf R}^{S}_{\boldsymbol{\tau}_{s'}})}.
\end{equation}
On output the dynamical matrix is still in the basis of the primitive reciprocal lattice vectors and the sum over $m,o$ in Eq.~\ref{dynmat_inv_smallq_rec} that is needed to bring it in Cartesian coordinates is made outside this routine.

\newpage

{\color{dark-blue}\chapter{Bibliography}}
\color{black}

\begin{enumerate}

\item
M. Tinkham, `Group theory and quantum mechanics', Dover Publications, New York,
(1992). 

\end{enumerate}

\end{document}


scale_sym_ops
